<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Royale - Lobby</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Subtle grid pattern */
        body::before {
            content: '';
            position: fixed;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 600px;
            width: 90%;
            position: relative;
            z-index: 1;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3em;
            font-weight: 900;
            margin-bottom: 12px;
            letter-spacing: -0.03em;
            line-height: 1;
            background: linear-gradient(180deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.95em;
            color: #666666;
            font-weight: 400;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
            position: relative;
            overflow: hidden;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .corner-tl,
        .corner-br {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .corner-tl {
            top: -1px;
            left: -1px;
            border-right: none;
            border-bottom: none;
            border-radius: 16px 0 0 0;
        }

        .corner-br {
            bottom: -1px;
            right: -1px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 16px 0;
        }

        /* Setup Screen */
        #setup-screen .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.8em;
            color: #999999;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 600;
        }

        input {
            width: 100%;
            padding: 16px 20px;
            font-size: 1em;
            font-family: 'JetBrains Mono', monospace;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #ffffff;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-weight: 400;
        }

        input:focus {
            outline: none;
            border-color: #ffffff;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .player-count-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .count-btn {
            padding: 14px;
            font-size: 1.1em;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .count-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .count-btn.selected {
            background: #ffffff;
            color: #000000;
            border-color: #ffffff;
            transform: scale(1.05);
        }

        .selected-count {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 0.95em;
            color: #888888;
        }

        .selected-count strong {
            color: #ffffff;
            font-size: 1.1em;
        }

        button {
            width: 100%;
            padding: 18px;
            font-size: 0.95em;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            background: #ffffff;
            border: none;
            border-radius: 8px;
            color: #000000;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 255, 255, 0.2);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Lobby Screen */
        #lobby-screen {
            display: none;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .status-badge.host {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .player-counter {
            text-align: center;
            font-size: 2.5em;
            font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
            margin: 24px 0;
            color: #ffffff;
        }

        .player-counter .current {
            font-size: 1.5em;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin: 24px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }

        .player-card.me {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .player-card.host-badge {
            position: relative;
        }

        .player-card.host-badge::before {
            content: 'ðŸ‘‘';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 1.2em;
        }

        .player-card .name {
            font-weight: 600;
            font-size: 0.95em;
            word-break: break-word;
        }

        .waiting-message {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9em;
            color: #888888;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2.2em;
            }

            .card {
                padding: 32px 24px;
            }

            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>QUIZ ROYALE</h1>
            <div class="subtitle">Battle Royale Quiz</div>
        </div>

        <div class="card">
            <div class="corner-tl"></div>
            <div class="corner-br"></div>
            
            <!-- Setup Screen (Name + Player Count) -->
            <div id="setup-screen">
                <div class="form-group">
                    <label>Dein Spielername</label>
                    <input 
                        type="text" 
                        id="player-name" 
                        placeholder="Name eingeben..."
                        maxlength="20"
                        autocomplete="off"
                    >
                </div>

                <!-- Host: Player count selection -->
                <div class="form-group" id="host-settings" style="display: none;">
                    <label>Anzahl der Spieler</label>
                    <div class="player-count-selector">
                        <button type="button" class="count-btn" data-count="2">2</button>
                        <button type="button" class="count-btn" data-count="3">3</button>
                        <button type="button" class="count-btn" data-count="4">4</button>
                        <button type="button" class="count-btn" data-count="5">5</button>
                        <button type="button" class="count-btn" data-count="6">6</button>
                        <button type="button" class="count-btn" data-count="7">7</button>
                        <button type="button" class="count-btn" data-count="8">8</button>
                        <button type="button" class="count-btn" data-count="9">9</button>
                        <button type="button" class="count-btn" data-count="10">10</button>
                    </div>
                    <div class="selected-count">
                        AusgewÃ¤hlt: <strong id="selected-count-text">2 Spieler</strong>
                    </div>
                </div>

                <button id="join-lobby-btn">Lobby beitreten</button>
            </div>

            <!-- Lobby Screen (Waiting for players) -->
            <div id="lobby-screen" class="hidden">
                <div style="text-align: center;">
                    <span class="status-badge" id="role-badge">Spieler</span>
                </div>

                <div class="player-counter">
                    <span class="current" id="current-players">0</span>
                    <span style="opacity: 0.4;">/</span>
                    <span id="max-players">2</span>
                </div>

                <div class="players-grid" id="players-grid">
                    <!-- Players will be added here -->
                </div>

                <div class="waiting-message" id="waiting-message">
                    Warte auf weitere Spieler...
                </div>

                <button id="start-game-btn" disabled>Spiel starten</button>
            </div>
        </div>
    </div>

    <script>
        const FIXED_ROOM_CODE = 'BATTLE2026';
        const WS_URL = 'wss://nosch.uber.space/web-rooms/';
        
        let socket = null;
        let keepAliveInterval = null;
        
        const state = {
            playerName: '',
            playerId: null,
            isHost: false,
            maxPlayers: 2,
            players: [],
            roomCode: FIXED_ROOM_CODE
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', init);

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const maxPlayers = urlParams.get('maxPlayers');
            
            if (!maxPlayers) {
                // First player = Host
                state.isHost = true;
                document.getElementById('host-settings').style.display = 'block';
                setupPlayerCountSelector();
            } else {
                // Joining existing lobby
                state.maxPlayers = parseInt(maxPlayers);
                state.isHost = false;
            }
            
            document.getElementById('join-lobby-btn').addEventListener('click', joinLobby);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            document.getElementById('player-name').focus();
        }

        function setupPlayerCountSelector() {
            const buttons = document.querySelectorAll('.count-btn');
            buttons.forEach(btn => {
                if (btn.dataset.count === '2') {
                    btn.classList.add('selected');
                }
                
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.maxPlayers = parseInt(btn.dataset.count);
                    document.getElementById('selected-count-text').textContent = 
                        `${state.maxPlayers} Spieler`;
                });
            });
        }

        function joinLobby() {
            const name = document.getElementById('player-name').value.trim();
            if (!name) {
                alert('Bitte gib einen Namen ein!');
                return;
            }
            
            state.playerName = name;
            state.playerId = Date.now();
            
            // Switch to lobby screen
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('max-players').textContent = state.maxPlayers;
            
            // Update role badge
            if (state.isHost) {
                document.getElementById('role-badge').textContent = 'ðŸ‘‘ Host';
                document.getElementById('role-badge').classList.add('host');
            }
            
            // Connect to WebSocket
            connectWebSocket();
        }

        function connectWebSocket() {
            console.log('ðŸ”Œ Connecting to WebSocket...');
            
            socket = new WebSocket(WS_URL);
            
            socket.addEventListener('open', () => {
                console.log('âœ… WebSocket connected!');
                
                // Join room
                sendRequest('join', state.roomCode);
                
                // Announce myself
                broadcastPlayerJoined();
                
                // Start keep-alive
                keepAliveInterval = setInterval(() => {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify(['*ping*']));
                    }
                }, 30000);
            });
            
            socket.addEventListener('message', (event) => {
                handleMessage(event.data);
            });
            
            socket.addEventListener('close', () => {
                console.log('ðŸ”Œ WebSocket closed');
                clearInterval(keepAliveInterval);
                
                // Reconnect after 2 seconds
                setTimeout(() => connectWebSocket(), 2000);
            });
        }

        function sendRequest(selector, ...args) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify([selector, ...args]));
            }
        }

        function broadcastPlayerJoined() {
            sendRequest('*broadcast-message*', JSON.stringify({
                type: 'player-joined',
                id: state.playerId,
                name: state.playerName,
                isHost: state.isHost,
                maxPlayers: state.maxPlayers
            }));
            
            // Add myself to players list
            addPlayer({
                id: state.playerId,
                name: state.playerName,
                isHost: state.isHost
            });
        }

        function handleMessage(data) {
            try {
                const parsed = JSON.parse(data);
                
                // Handle broadcast messages
                if (Array.isArray(parsed) && parsed.length === 1 && typeof parsed[0] === 'string') {
                    const message = JSON.parse(parsed[0]);
                    handleGameMessage(message);
                } else if (Array.isArray(parsed) && parsed.length > 1) {
                    const [selector, ...args] = parsed;
                    if (args.length > 0 && typeof args[0] === 'string') {
                        const message = JSON.parse(args[0]);
                        handleGameMessage(message);
                    }
                }
            } catch (e) {
                // Ignore parse errors
            }
        }

        function handleGameMessage(message) {
            console.log('ðŸ“¨ Received:', message.type);
            
            switch (message.type) {
                case 'player-joined':
                    handlePlayerJoined(message);
                    break;
                case 'host-start-game':
                    redirectToGame();
                    break;
            }
        }

        function handlePlayerJoined(data) {
            // Don't add myself again
            if (data.id === state.playerId) return;
            
            console.log('âž• Player joined:', data.name);
            
            // Update maxPlayers if host joined
            if (data.isHost && data.maxPlayers) {
                state.maxPlayers = data.maxPlayers;
                document.getElementById('max-players').textContent = state.maxPlayers;
            }
            
            addPlayer(data);
        }

        function addPlayer(player) {
            // Check if already exists
            if (state.players.find(p => p.id === player.id)) return;
            
            state.players.push(player);
            updatePlayersDisplay();
        }

        function updatePlayersDisplay() {
            const grid = document.getElementById('players-grid');
            grid.innerHTML = '';
            
            state.players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                
                if (player.id === state.playerId) {
                    card.classList.add('me');
                }
                
                if (player.isHost) {
                    card.classList.add('host-badge');
                }
                
                card.innerHTML = `<div class="name">${player.name}</div>`;
                grid.appendChild(card);
            });
            
            // Update counter
            document.getElementById('current-players').textContent = state.players.length;
            
            // Update messages and buttons
            if (state.players.length >= state.maxPlayers) {
                document.getElementById('waiting-message').textContent = 
                    'Alle Spieler sind da! Host kann das Spiel starten.';
                
                if (state.isHost) {
                    document.getElementById('start-game-btn').disabled = false;
                }
            } else {
                document.getElementById('waiting-message').textContent = 
                    `Warte auf ${state.maxPlayers - state.players.length} weitere Spieler...`;
            }
        }

        function startGame() {
            if (!state.isHost) return;
            if (state.players.length < state.maxPlayers) {
                alert('Nicht alle Spieler sind da!');
                return;
            }
            
            console.log('ðŸŽ® Host starting game!');
            
            // Broadcast game start
            sendRequest('*broadcast-message*', JSON.stringify({
                type: 'host-start-game',
                players: state.players
            }));
            
            // Redirect myself
            redirectToGame();
        }

        function redirectToGame() {
            const params = new URLSearchParams({
                room: state.roomCode,
                player: state.playerName,
                playerId: state.playerId,
                isHost: state.isHost,
                maxPlayers: state.maxPlayers,
                players: JSON.stringify(state.players)
            });
            
            window.location.href = `game.html?${params.toString()}`;
        }
    </script>
</body>
</html>